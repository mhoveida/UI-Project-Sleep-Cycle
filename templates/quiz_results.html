{% extends "quiz_base.html" %}
{% block title %}Quiz Results{% endblock %}
{% set hide_nav = true %}
{% set hide_hint = true %}
{% block heading %}Your Quiz Results{% endblock %}
{% block hint_text %}See how well you know your sleep cycles!{% endblock %}

{% block quiz_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quiz_results.css') }}">

<div class="result-container">
  <h2 id="result-title">Loading...</h2>
  <p class="score-text" id="result-score"></p>
  <p class="message" id="result-message"></p>
  <p class="completed" id="completed-quizzes"></p>
  <div class="score-breakdown-card">
    <div class="score-breakdown-header">
      <span class="score-breakdown-title">Score Breakdown</span>
      <span class="score-badge">Total: <b>24</b> points</span>
    </div>
    <ul class="score-breakdown-list">
      <li>
        <span class="score-icon">①</span>
        <span class="score-label">Quiz 1: Sleep Cycle Sequence</span>
        <div class="score-bar-wrap">
          <div class="score-bar-bg"><div class="score-bar" id="quiz1-bar"></div></div>
          <span class="score-value" id="quiz1-score">?</span><span class="score-max">/4</span>
        </div>
      </li>
      <li>
        <span class="score-icon">②</span>
        <span class="score-label">Quiz 2: Sleep Disruptor Effects</span>
        <div class="score-bar-wrap">
          <div class="score-bar-bg"><div class="score-bar" id="quiz2-bar"></div></div>
          <span class="score-value" id="quiz2-score">?</span><span class="score-max">/10</span>
        </div>
      </li>
      <li>
        <span class="score-icon">③</span>
        <span class="score-label">Quiz 3: Match Scenarios to Sleep Stages</span>
        <div class="score-bar-wrap">
          <div class="score-bar-bg"><div class="score-bar" id="quiz3-bar"></div></div>
          <span class="score-value" id="quiz3-score">?</span><span class="score-max">/6</span>
        </div>
      </li>
      <li>
        <span class="score-icon">④</span>
        <span class="score-label">Quiz 4: Best Wake-up Time</span>
        <div class="score-bar-wrap">
          <div class="score-bar-bg"><div class="score-bar" id="quiz4-bar"></div></div>
          <span class="score-value" id="quiz4-score">?</span><span class="score-max">/1</span>
        </div>
      </li>
      <li>
        <span class="score-icon">⑤</span>
        <span class="score-label">Quiz 5: Mixed Sleep Questions</span>
        <div class="score-bar-wrap">
          <div class="score-bar-bg"><div class="score-bar" id="quiz5-bar"></div></div>
          <span class="score-value" id="quiz5-score">?</span><span class="score-max">/3</span>
        </div>
      </li>
    </ul>
  </div>

<div class="result-buttons">
  <a href="/learn/1" class="left-button">Review Sleep Stages</a>
  <a href="/quiz_results/q1" class="middle-button">View Correct Choices</a>
  <a href="{{ url_for('quiz1_sequence') }}" class="right-button">Try Again</a>
</div>

</div>
{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    fetch('/quiz_results', {
        method: 'POST'
    }).then(response => response.json())
      .then(data => {
        document.getElementById('result-title').innerText = data.feedback.title;
        document.getElementById('result-score').innerText = 'Score: ' + data.feedback.score;
        document.getElementById('result-message').innerText = data.feedback.message;
        document.getElementById('completed-quizzes').innerText = 'Quizzes Completed: ' + data.completed_quizzes + '/5';
        
        // Update individual quiz scores if available
        if (data.quiz_scores) {
          document.getElementById('quiz1-score').innerText = data.quiz_scores.quiz1 || '?';
          document.getElementById('quiz2-score').innerText = data.quiz_scores.quiz2 || '?';
          document.getElementById('quiz3-score').innerText = data.quiz_scores.quiz3 || '?';
          document.getElementById('quiz4-score').innerText = data.quiz_scores.quiz4 || '?';
          document.getElementById('quiz5-score').innerText = data.quiz_scores.quiz5 || '?';
          // 动态设置进度条宽度
          function setBar(id, score, max) {
            const bar = document.getElementById(id);
            if (bar && !isNaN(score) && !isNaN(max) && max > 0) {
              bar.style.width = (Math.max(0, Math.min(score, max)) / max * 100) + '%';
            } else {
              bar.style.width = '0%';
            }
          }
          setBar('quiz1-bar', Number(data.quiz_scores.quiz1), 4);
          setBar('quiz2-bar', Number(data.quiz_scores.quiz2), 10);
          setBar('quiz3-bar', Number(data.quiz_scores.quiz3), 6);
          setBar('quiz4-bar', Number(data.quiz_scores.quiz4), 1);
          setBar('quiz5-bar', Number(data.quiz_scores.quiz5), 3);
        }
      }).catch(error => {
        console.error('Error fetching results:', error);
        document.getElementById('result-title').innerText = 'Error';
        document.getElementById('result-message').innerText = 'Unable to load quiz results.';
      });
});
</script>
{% endblock %}
