{% extends "quiz_base.html" %}

{% set next_url = url_for('quiz4_multiple') %}
{% set back_url = url_for('quiz2_dragdrop') %}
{% set active_index = 2 %}  <!-- quiz3 -->

{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quiz3.css') }}">
{% endblock %}

{% block title %}Quiz 3: Match Sleep Stages{% endblock %}
{% block heading %}Match the Scenario to Sleep Stage{% endblock %}
{% block hint_text %}
Match each person's vibe to their sleep stage!
{% endblock %}

{% block quiz_content %}

<div class="match-container">
  <!-- 左侧标签 -->
  <div class="left-side">
    {% set labels = [
      "Sufficient N3 Deep Sleep",
      "Complete REM Cycles",
      "Insufficient N3 Deep Sleep",
      "Multiple REM cycles",
      "N2 Deeper Light Sleep",
      "Disrupted N3 Deep Sleep"
    ] %}
    {% for label in labels %}
      <div class="match-item" data-label="{{ loop.index0 }}">
        <span>{{ label }}</span>
        <span class="connector left-connector" data-index="{{ loop.index0 }}"></span>
      </div>
    {% endfor %}
  </div>

  <!-- 右侧图片 -->
  <div class="right-side">
    {% set images = [
      "Sick.png", "Sport.png", "Forget.png",
      "Solve.png", "Guitar.png", "Recovery.png"
    ] %}
    {% for img in images %}
      <div class="match-item" data-label="{{ loop.index0 }}">
        <span class="connector right-connector" data-index="{{ loop.index0 }}"></span>
        <img src="{{ url_for('static', filename='media/Quiz/Q3/' ~ img) }}" alt="Scenario {{ loop.index0 }}">
      </div>
    {% endfor %}
  </div>

  <!-- SVG画布：绘制线条 -->
  <svg class="match-lines"></svg>
</div>
{% endblock %}

{% block script %}
<script>
const next_url = "{{ next_url }}";
</script>
<script src="{{ url_for('static', filename='js/quiz3.js') }}"></script>
<script>
// The 'Next' button acts as both a submit and navigation button.
// It collects the user's matches, submits via AJAX, then navigates to the next page.
const nextButton = document.querySelector('.button.next');
nextButton.addEventListener('click', function(e) {
  const matches = {};
  document.querySelectorAll('.match-lines line').forEach(line => {
    const leftIndex = line.dataset.leftIndex;
    const rightIndex = line.dataset.rightIndex;
    const labelText = document.querySelector(`.left-connector[data-index="${leftIndex}"]`).parentElement.querySelector('span').innerText;
    const imageSrc = document.querySelector(`.right-connector[data-index="${rightIndex}"]`).nextElementSibling.getAttribute('src');
    matches[labelText] = imageSrc.split('/').pop().replace('.png', '');
  });

  fetch('/submit_quiz3', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(matches)
  }).then(() => {
    window.location.href = next_url;
  });
});

document.querySelector('.button.back').addEventListener('click', function(e) {
  e.preventDefault();
  window.location.href = "{{ back_url }}";
});
</script>
{% endblock %}